//Requires node.js with web3

var Web3 = require('web3');
const readline = require('readline');
var _parentAddress = '0xfeda81f064cb27c68e3906375aeb402429c138ee';
var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));

var libraryABI = [{"name": "Donation", "inputs": [{"type": "address", "name": "_from", "indexed": true}, {"type": "int128", "name": "_value", "indexed": false}, {"type": "int128", "name": "_bookID", "indexed": false}], "anonymous": false, "type": "event"}, {"name": "BookUploaded", "inputs": [{"type": "int128", "name": "_bookID", "indexed": false}], "anonymous": false, "type": "event"}, {"name": "TextUploaded", "inputs": [{"type": "int128", "name": "_bookID", "indexed": false}], "anonymous": false, "type": "event"}, {"name": "getBookAddress", "outputs": [{"type": "address", "name": "out"}], "inputs": [{"type": "int128", "name": "_bookID"}], "constant": true, "payable": false, "type": "function", "gas": 672}, {"name": "__init__", "outputs": [], "inputs": [{"type": "address[3]", "name": "_foundationAddresses"}], "constant": false, "payable": false, "type": "constructor"}, {"name": "changeFoundationAddresses", "outputs": [], "inputs": [{"type": "int128", "name": "index"}, {"type": "address", "name": "newAddress"}], "constant": false, "payable": false, "type": "function", "gas": 22130}, {"name": "donate", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "int128", "name": "foundationSplitNumerator"}, {"type": "int128", "name": "foundationSplitDenominator"}], "constant": false, "payable": true, "type": "function", "gas": 41261}, {"name": "donateWithDifferentDonor", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "int128", "name": "foundationSplitNumerator"}, {"type": "int128", "name": "foundationSplitDenominator"}, {"type": "address", "name": "donorAddress"}], "constant": false, "payable": true, "type": "function", "gas": 41236}, {"name": "setUpdateAddress", "outputs": [], "inputs": [{"type": "address", "name": "newUpdateAddress"}], "constant": false, "payable": false, "type": "function", "gas": 21889}, {"name": "addBook", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "address", "name": "bookAddress"}], "constant": false, "payable": false, "type": "function", "gas": 22096}, {"name": "setTextAddress", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "address", "name": "textAddress"}], "constant": false, "payable": false, "type": "function", "gas": 5981}, {"name": "setExpansionAddress", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "address", "name": "expansionAddress"}], "constant": false, "payable": false, "type": "function", "gas": 4661}, {"name": "foundationAddresses", "outputs": [{"type": "address", "name": "out"}], "inputs": [{"type": "int128", "name": "arg0"}], "constant": true, "payable": false, "type": "function", "gas": 940}, {"name": "updateAddress", "outputs": [{"type": "address", "name": "out"}], "inputs": [], "constant": true, "payable": false, "type": "function", "gas": 753}, {"name": "updatedContract", "outputs": [{"type": "bool", "name": "out"}], "inputs": [], "constant": true, "payable": false, "type": "function", "gas": 783}, {"name": "books", "outputs": [{"type": "address", "name": "out"}], "inputs": [{"type": "int128", "name": "arg0"}], "constant": true, "payable": false, "type": "function", "gas": 1002}];

var libraryCode = '0x600035601c52740100000000000000000000000000000000000000006020526f7fffffffffffffffffffffffffffffff6040527fffffffffffffffffffffffffffffffff8000000000000000000000000000000060605274012a05f1fffffffffffffffffffffffffdabf41c006080527ffffffffffffffffffffffffed5fa0e000000000000000000000000000000000060a0526060610c3b6101403934156100a757600080fd5b6020610c3b60c03960c05160205181106100c057600080fd5b5060206020610c3b0160c03960c05160205181106100dd57600080fd5b5060206040610c3b0160c03960c05160205181106100fa57600080fd5b50600060c052602060c02061014080600060200201516000830155806001602002015160018301558060026020020151600283015550506000600255610c2356600035601c52740100000000000000000000000000000000000000006020526f7fffffffffffffffffffffffffffffff6040527fffffffffffffffffffffffffffffffff8000000000000000000000000000000060605274012a05f1fffffffffffffffffffffffffdabf41c006080527ffffffffffffffffffffffffed5fa0e000000000000000000000000000000000060a05263ba7b7a6d60005114156100eb57602060046101403734156100b457600080fd5b606051600435806040519013585780919012156100d057600080fd5b5061014051600360c052602060c020015460005260206000f3005b63a8d4dbaf60005114156101d1576040600461014037341561010c57600080fd5b6060516004358060405190135857809190121561012857600080fd5b50602435602051811061013a57600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c02001543314156101705760018352610181565b5b8151600101808352811415610150575b5050506101805160011461019457600080fd5b60026101405113156000610140511215166101ae57600080fd5b6101605161014051600381106101c357600080fd5b600060c052602060c0200155005b638bd942d860005114156103f95760606004610140376060516004358060405190135857809190121561020357600080fd5b506060516024358060405190135857809190121561022057600080fd5b506060516044358060405190135857809190121561023d57600080fd5b506101805161016051131561025157600080fd5b600254156102b4576001543b61026657600080fd5b60015430141561027557600080fd5b600060006064638bd942d861028052610140516102a052610160516102c052610180516102e05261029c60006001545af16102af57600080fd5b6103f7565b6402540be400600160a05161018051806102cd57600080fd5b6402540be400606051610160513402806040519013585780919012156102f257600080fd5b02058060805190135857809190121561030a57600080fd5b02046101a05260006000600060006101a0516000600060c052602060c02001546000f161033657600080fd5b61014051600360c052602060c02001543b61035057600080fd5b61014051600360c052602060c020015430141561036c57600080fd5b600060006024636237dd9c6101c0526060516101a05160013402038060405190135857809190121561039d57600080fd5b6101e0526101dc600061014051600360c052602060c02001545af16103c157600080fd5b34610240526101405161026052337f1e4e27e3d0ff7c90c9293487ee3fb6a47e0730e22d8c169e25abcdd34b6c8c196040610240a25b005b635615fbb8600051141561062b5760806004610140376060516004358060405190135857809190121561042b57600080fd5b506060516024358060405190135857809190121561044857600080fd5b506060516044358060405190135857809190121561046557600080fd5b50606435602051811061047757600080fd5b50600254156104e3576001543b61048d57600080fd5b60015430141561049c57600080fd5b600060006084635615fbb86102a052610140516102c052610160516102e05261018051610300526101a051610320526102bc60006001545af16104de57600080fd5b610629565b6402540be400600160a05161018051806104fc57600080fd5b6402540be4006060516101605134028060405190135857809190121561052157600080fd5b02058060805190135857809190121561053957600080fd5b02046101c05260006000600060006101c0516000600060c052602060c02001546000f161056557600080fd5b61014051600360c052602060c02001543b61057f57600080fd5b61014051600360c052602060c020015430141561059b57600080fd5b600060006024636237dd9c6101e0526060516101c0516001340203806040519013585780919012156105cc57600080fd5b610200526101fc600061014051600360c052602060c02001545af16105f057600080fd5b346102605261014051610280526101a0517f1e4e27e3d0ff7c90c9293487ee3fb6a47e0730e22d8c169e25abcdd34b6c8c196040610260a25b005b631a9faa8060005114156106c0576020600461014037341561064c57600080fd5b600435602051811061065d57600080fd5b5060006101605261016061010060006003818352015b61010051600060c052602060c020015433141561069357600183526106a4565b5b8151600101808352811415610673575b505050610160516001146106b757600080fd5b61014051600155005b63183ca6af600051141561077f57604060046101403734156106e157600080fd5b606051600435806040519013585780919012156106fd57600080fd5b50602435602051811061070f57600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c02001543314156107455760018352610756565b5b8151600101808352811415610725575b5050506101805160011461076957600080fd5b6101605161014051600360c052602060c0200155005b634e087e7460005114156108c657604060046101403734156107a057600080fd5b606051600435806040519013585780919012156107bc57600080fd5b5060243560205181106107ce57600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c02001543314156108045760018352610815565b5b81516001018083528114156107e4575b5050506101805160011461082857600080fd5b61014051600360c052602060c02001543b61084257600080fd5b61014051600360c052602060c020015430141561085e57600080fd5b60006000602463218e13b76101a052610160516101c0526101bc600061014051600360c052602060c02001545af161089557600080fd5b61014051610220527f06dee5cfead0cfc8daa402069e1fa42fd9cdf46ce4d1211c43c5381c416c95f26020610220a1005b637b3a58eb60005114156109de57604060046101403734156108e757600080fd5b6060516004358060405190135857809190121561090357600080fd5b50602435602051811061091557600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c020015433141561094b576001835261095c565b5b815160010180835281141561092b575b5050506101805160011461096f57600080fd5b61014051600360c052602060c02001543b61098957600080fd5b61014051600360c052602060c02001543014156109a557600080fd5b60006000602463e74637956101a052610160516101c0526101bc600061014051600360c052602060c02001545af16109dc57600080fd5b005b638a1a5b6e6000511415610a4357602060046101403734156109ff57600080fd5b60605160043580604051901358578091901215610a1b57600080fd5b506101405160038110610a2d57600080fd5b600060c052602060c020015460005260206000f3005b63d59768a36000511415610a69573415610a5c57600080fd5b60015460005260206000f3005b63126f30206000511415610a8f573415610a8257600080fd5b60025460005260206000f3005b636c578b716000511415610ae75760206004610140373415610ab057600080fd5b60605160043580604051901358578091901215610acc57600080fd5b5061014051600360c052602060c020015460005260206000f3005b5b61013b610c230361013b60003961013b610c23036000f3';

function launchContract(password) {
	web3.eth.personal.unlockAccount(_parentAddress, password).then(function(){

		var currentContract = new web3.eth.Contract(libraryABI);
		var gasEstimate;

		currentContract.deploy({
			data: libraryCode,
			arguments: [[_parentAddress, _parentAddress, _parentAddress]]
		})
		.estimateGas(function(err, gas){
			console.log('Gas Estimate: ' + gas);
			gasEstimate = gas;
		}).then(function(){

			currentContract.deploy({
				data: libraryCode,
				arguments: [[_parentAddress, _parentAddress, _parentAddress]]
			})
			.send({
				from: _parentAddress,
				gas: gasEstimate,
				gasPrice: '30000000000000'
			},
			function(error, transactionHash){})
			.on('error', function(error){ console.log(error); })
			.on('transactionHash', function(transactionHash){ console.log('Tx hash:' + transactionHash); })
			.on('receipt', function(receipt){
				console.log(receipt.contractAddress); // contains the new contract address
			})
			.on('confirmation', function(confirmationNumber, receipt){ })
			.then(function(newContractInstance){
				console.log(newContractInstance.options.address); // instance with the new contract address
			});
		});
	});
}

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

rl.question('Input password: ', (answer) => {
	launchContract(answer);
	rl.close();
});