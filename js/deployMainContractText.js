//Requires node.js with web3

var Web3 = require('web3');
const readline = require('readline');
var _parentAddress = '0xfeda81f064cb27c68e3906375aeb402429c138ee';
var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));

var libraryABI = [{"name": "Donation", "inputs": [{"type": "address", "name": "_from", "indexed": true}, {"type": "int128", "name": "_value", "indexed": false}, {"type": "int128", "name": "_bookID", "indexed": false}], "anonymous": false, "type": "event"}, {"name": "BookUploaded", "inputs": [{"type": "int128", "name": "_bookID", "indexed": false}], "anonymous": false, "type": "event"}, {"name": "TextUploaded", "inputs": [{"type": "int128", "name": "_bookID", "indexed": false}], "anonymous": false, "type": "event"}, {"name": "__init__", "outputs": [], "inputs": [{"type": "address[3]", "name": "_foundationAddresses"}], "constant": false, "payable": false, "type": "constructor"}, {"name": "changeFoundationAddresses", "outputs": [], "inputs": [{"type": "int128", "name": "index"}, {"type": "address", "name": "newAddress"}], "constant": false, "payable": false, "type": "function", "gas": 22100}, {"name": "donate", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "int128", "name": "foundationSplitNumerator"}, {"type": "int128", "name": "foundationSplitDenominator"}], "constant": false, "payable": true, "type": "function", "gas": 41231}, {"name": "donateWithDifferentDonor", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "int128", "name": "foundationSplitNumerator"}, {"type": "int128", "name": "foundationSplitDenominator"}, {"type": "address", "name": "donorAddress"}], "constant": false, "payable": true, "type": "function", "gas": 41206}, {"name": "setUpdateAddress", "outputs": [], "inputs": [{"type": "address", "name": "newUpdateAddress"}], "constant": false, "payable": false, "type": "function", "gas": 21859}, {"name": "addBook", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "address", "name": "bookAddress"}], "constant": false, "payable": false, "type": "function", "gas": 22066}, {"name": "setTextAddress", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "address", "name": "textAddress"}], "constant": false, "payable": false, "type": "function", "gas": 5951}, {"name": "setExpansionAddress", "outputs": [], "inputs": [{"type": "int128", "name": "id"}, {"type": "address", "name": "expansionAddress"}], "constant": false, "payable": false, "type": "function", "gas": 4631}, {"name": "foundationAddresses", "outputs": [{"type": "address", "name": "out"}], "inputs": [{"type": "int128", "name": "arg0"}], "constant": true, "payable": false, "type": "function", "gas": 910}, {"name": "updateAddress", "outputs": [{"type": "address", "name": "out"}], "inputs": [], "constant": true, "payable": false, "type": "function", "gas": 723}, {"name": "updatedContract", "outputs": [{"type": "bool", "name": "out"}], "inputs": [], "constant": true, "payable": false, "type": "function", "gas": 753}, {"name": "books", "outputs": [{"type": "address", "name": "out"}], "inputs": [{"type": "int128", "name": "arg0"}], "constant": true, "payable": false, "type": "function", "gas": 972}];

var libraryCode = '0x600035601c52740100000000000000000000000000000000000000006020526f7fffffffffffffffffffffffffffffff6040527fffffffffffffffffffffffffffffffff8000000000000000000000000000000060605274012a05f1fffffffffffffffffffffffffdabf41c006080527ffffffffffffffffffffffffed5fa0e000000000000000000000000000000000060a0526060610be36101403934156100a757600080fd5b6020610be360c03960c05160205181106100c057600080fd5b5060206020610be30160c03960c05160205181106100dd57600080fd5b5060206040610be30160c03960c05160205181106100fa57600080fd5b50600060c052602060c02061014080600060200201516000830155806001602002015160018301558060026020020151600283015550506000600255610bcb56600035601c52740100000000000000000000000000000000000000006020526f7fffffffffffffffffffffffffffffff6040527fffffffffffffffffffffffffffffffff8000000000000000000000000000000060605274012a05f1fffffffffffffffffffffffffdabf41c006080527ffffffffffffffffffffffffed5fa0e000000000000000000000000000000000060a05263a8d4dbaf600051141561017957604060046101403734156100b457600080fd5b606051600435806040519013585780919012156100d057600080fd5b5060243560205181106100e257600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c02001543314156101185760018352610129565b5b81516001018083528114156100f8575b5050506101805160011461013c57600080fd5b600261014051131560006101405112151661015657600080fd5b61016051610140516003811061016b57600080fd5b600060c052602060c0200155005b638bd942d860005114156103a1576060600461014037606051600435806040519013585780919012156101ab57600080fd5b50606051602435806040519013585780919012156101c857600080fd5b50606051604435806040519013585780919012156101e557600080fd5b50610180516101605113156101f957600080fd5b6002541561025c576001543b61020e57600080fd5b60015430141561021d57600080fd5b600060006064638bd942d861028052610140516102a052610160516102c052610180516102e05261029c60006001545af161025757600080fd5b61039f565b6402540be400600160a051610180518061027557600080fd5b6402540be4006060516101605134028060405190135857809190121561029a57600080fd5b0205806080519013585780919012156102b257600080fd5b02046101a05260006000600060006101a0516000600060c052602060c02001546000f16102de57600080fd5b61014051600360c052602060c02001543b6102f857600080fd5b61014051600360c052602060c020015430141561031457600080fd5b600060006024636237dd9c6101c0526060516101a05160013402038060405190135857809190121561034557600080fd5b6101e0526101dc600061014051600360c052602060c02001545af161036957600080fd5b34610240526101405161026052337f1e4e27e3d0ff7c90c9293487ee3fb6a47e0730e22d8c169e25abcdd34b6c8c196040610240a25b005b635615fbb860005114156105d3576080600461014037606051600435806040519013585780919012156103d357600080fd5b50606051602435806040519013585780919012156103f057600080fd5b506060516044358060405190135857809190121561040d57600080fd5b50606435602051811061041f57600080fd5b506002541561048b576001543b61043557600080fd5b60015430141561044457600080fd5b600060006084635615fbb86102a052610140516102c052610160516102e05261018051610300526101a051610320526102bc60006001545af161048657600080fd5b6105d1565b6402540be400600160a05161018051806104a457600080fd5b6402540be400606051610160513402806040519013585780919012156104c957600080fd5b0205806080519013585780919012156104e157600080fd5b02046101c05260006000600060006101c0516000600060c052602060c02001546000f161050d57600080fd5b61014051600360c052602060c02001543b61052757600080fd5b61014051600360c052602060c020015430141561054357600080fd5b600060006024636237dd9c6101e0526060516101c05160013402038060405190135857809190121561057457600080fd5b610200526101fc600061014051600360c052602060c02001545af161059857600080fd5b346102605261014051610280526101a0517f1e4e27e3d0ff7c90c9293487ee3fb6a47e0730e22d8c169e25abcdd34b6c8c196040610260a25b005b631a9faa80600051141561066857602060046101403734156105f457600080fd5b600435602051811061060557600080fd5b5060006101605261016061010060006003818352015b61010051600060c052602060c020015433141561063b576001835261064c565b5b815160010180835281141561061b575b5050506101605160011461065f57600080fd5b61014051600155005b63183ca6af6000511415610727576040600461014037341561068957600080fd5b606051600435806040519013585780919012156106a557600080fd5b5060243560205181106106b757600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c02001543314156106ed57600183526106fe565b5b81516001018083528114156106cd575b5050506101805160011461071157600080fd5b6101605161014051600360c052602060c0200155005b634e087e74600051141561086e576040600461014037341561074857600080fd5b6060516004358060405190135857809190121561076457600080fd5b50602435602051811061077657600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c02001543314156107ac57600183526107bd565b5b815160010180835281141561078c575b505050610180516001146107d057600080fd5b61014051600360c052602060c02001543b6107ea57600080fd5b61014051600360c052602060c020015430141561080657600080fd5b60006000602463218e13b76101a052610160516101c0526101bc600061014051600360c052602060c02001545af161083d57600080fd5b61014051610220527f06dee5cfead0cfc8daa402069e1fa42fd9cdf46ce4d1211c43c5381c416c95f26020610220a1005b637b3a58eb6000511415610986576040600461014037341561088f57600080fd5b606051600435806040519013585780919012156108ab57600080fd5b5060243560205181106108bd57600080fd5b5060006101805261018061010060006003818352015b61010051600060c052602060c02001543314156108f35760018352610904565b5b81516001018083528114156108d3575b5050506101805160011461091757600080fd5b61014051600360c052602060c02001543b61093157600080fd5b61014051600360c052602060c020015430141561094d57600080fd5b60006000602463e74637956101a052610160516101c0526101bc600061014051600360c052602060c02001545af161098457600080fd5b005b638a1a5b6e60005114156109eb57602060046101403734156109a757600080fd5b606051600435806040519013585780919012156109c357600080fd5b5061014051600381106109d557600080fd5b600060c052602060c020015460005260206000f3005b63d59768a36000511415610a11573415610a0457600080fd5b60015460005260206000f3005b63126f30206000511415610a37573415610a2a57600080fd5b60025460005260206000f3005b636c578b716000511415610a8f5760206004610140373415610a5857600080fd5b60605160043580604051901358578091901215610a7457600080fd5b5061014051600360c052602060c020015460005260206000f3005b5b61013b610bcb0361013b60003961013b610bcb036000f3';

function launchContract(password) {
	web3.eth.personal.unlockAccount(_parentAddress, password).then(function(){

		var currentContract = new web3.eth.Contract(libraryABI);
		var gasEstimate;

		currentContract.deploy({
			data: libraryCode,
			arguments: [[_parentAddress, _parentAddress, _parentAddress]]
		})
		.estimateGas(function(err, gas){
			console.log('Gas Estimate: ' + gas);
			gasEstimate = gas;
		}).then(function(){

			currentContract.deploy({
				data: libraryCode,
				arguments: [[_parentAddress, _parentAddress, _parentAddress]]
			})
			.send({
				from: _parentAddress,
				gas: gasEstimate,
				gasPrice: '30000000000000'
			},
			function(error, transactionHash){})
			.on('error', function(error){ console.log(error); })
			.on('transactionHash', function(transactionHash){ console.log('Tx hash:' + transactionHash); })
			.on('receipt', function(receipt){
				console.log(receipt.contractAddress); // contains the new contract address
			})
			.on('confirmation', function(confirmationNumber, receipt){ })
			.then(function(newContractInstance){
				console.log(newContractInstance.options.address); // instance with the new contract address
			});
		});
	});
}

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

rl.question('Input password: ', (answer) => {
	launchContract(answer);
	rl.close();
});